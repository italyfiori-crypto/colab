# 会员码功能使用说明

## 功能概述

会员码功能为小程序提供了完整的会员体系，包括：
- 后台批量生成会员码
- 用户激活会员码获得权限
- 免费用户仅可访问书籍前2章，会员用户可访问全部内容
- 学习单词功能不受会员限制

## 会员码类型

| 类型 | 前缀 | 有效期 | 说明 |
|------|------|--------|------|
| 1 | 1Y | 1年 | 12个月会员权限 |
| 2 | 2Y | 2年 | 24个月会员权限 |
| 5 | 5Y | 5年 | 60个月会员权限 |
| 99 | LT | 终身 | 永久会员权限 |

## 会员码格式

会员码为12位字符，格式为：`[类型前缀2位][随机字符8位][校验码2位]`

- **类型前缀**: 1Y/2Y/5Y/LT
- **随机字符**: 使用数字2-9和字母A-Z（排除易混淆字符0,1,O,I）
- **校验码**: 基于前10位字符计算的2位校验码

示例会员码：
- `1YA2B3C4D5E6` (1年会员)
- `LTX9Y8Z7W6V5` (终身会员)

## 使用流程

### 1. 生成会员码

```bash
cd script/upload

# 生成会员码
python membership_code_generator.py --type 1 --count 100
python membership_code_generator.py --type 99 --count 50

# 验证会员码格式
python membership_code_generator.py --validate 1YA2B3C4D5E6
```

### 2. 上传会员码到数据库

首先设置环境变量：
```bash
export WECHAT_APP_ID="your_app_id"
export WECHAT_APP_SECRET="your_app_secret"  
export WECHAT_ENV_ID="your_env_id"
```

然后上传：
```bash
# 上传生成的会员码CSV文件
python membership_code_uploader.py --file membership_codes_1Y_20231201.csv

# 批量大小为50（默认20）
python membership_code_uploader.py --file membership_codes_LT_20231201.csv --batch-size 50

# 强制上传（不跳过已存在记录）
python membership_code_uploader.py --file codes.csv --force
```

### 3. 用户激活会员码

用户可通过以下方式激活会员码：

#### 方式一：个人页面激活
1. 进入小程序个人设置页面
2. 点击会员卡片上的"激活"按钮
3. 输入12位会员码
4. 点击"激活"按钮完成

#### 方式二：章节页面激活
1. 在书籍详情页点击锁定的章节
2. 弹出会员码输入框
3. 输入12位会员码
4. 点击"立即激活"完成

### 4. 权限控制规则

- **免费用户**: 只能访问每本书的第1-2章
- **会员用户**: 可以访问所有书籍的全部章节
- **单词学习**: 所有用户都可以使用，不受会员限制
- **会员叠加**: 多个会员码可以叠加使用，延长有效期

## 数据库设计

### membership_codes 表
```javascript
{
  _id: string,              // 会员码ID (12位会员码)
  code_type: string,        // 会员类型: "1"/"2"/"5"/"99"
  use_status: string,       // 使用状态: "unused"/"used"/"expired"
  active: boolean,          // 可用状态
  used_at: number,          // 使用时间戳
  used_by: string,          // 使用者openid
  created_at: number,       // 创建时间戳
  updated_at: number        // 更新时间戳
}
```

### user_memberships 表
```javascript
{
  _id: string,              // 用户openid
  expire_time: number,      // 会员到期时间戳
  activated_codes: [{       // 激活历史
    code: string,           // 会员码
    code_type: string,      // 类型
    activated_at: number    // 激活时间
  }],
  created_at: number,       // 创建时间戳
  updated_at: number        // 更新时间戳
}
```

## 云函数接口

### membershipManager 云函数

#### 激活会员码
```javascript
wx.cloud.callFunction({
  name: 'membershipManager',
  data: {
    action: 'activateCode',
    code: '1YA2B3C4D5E6'
  }
})
```

#### 检查会员状态
```javascript
wx.cloud.callFunction({
  name: 'membershipManager',
  data: {
    action: 'checkMembership'
  }
})
```

#### 获取激活历史
```javascript
wx.cloud.callFunction({
  name: 'membershipManager',
  data: {
    action: 'getMembershipHistory'
  }
})
```

### bookDetailData 云函数更新

现在返回数据中包含会员信息和章节权限：
```javascript
{
  code: 0,
  data: {
    bookInfo: {...},
    chapters: [{
      // 现有字段...
      is_accessible: boolean,   // 是否可访问
      lock_reason: string      // 锁定原因
    }],
    membershipInfo: {
      is_premium: boolean,      // 是否会员
      expire_time: number,      // 到期时间
      days_remaining: number    // 剩余天数
    }
  }
}
```

## 测试验证

运行测试脚本验证功能：
```bash
cd script/upload
python test_membership_codes.py
```

测试内容包括：
- 会员码生成功能
- 会员码格式验证
- 会员码唯一性检查

## 注意事项

1. **安全性**：
   - 会员码采用12位复杂字符，难以暴力破解
   - 包含校验码，防止伪造
   - 数据库操作使用事务，确保一致性

2. **用户体验**：
   - 激活后立即生效
   - 支持会员码叠加使用
   - 友好的错误提示

3. **管理建议**：
   - 定期备份会员码数据
   - 监控会员码使用情况
   - 及时处理过期会员问题

## 故障排查

### 常见问题

1. **会员码激活失败**
   - 检查会员码格式是否正确
   - 确认会员码未被使用
   - 检查网络连接

2. **章节仍然锁定**
   - 确认会员码激活成功
   - 刷新页面重新加载数据
   - 检查会员有效期

3. **上传脚本失败**
   - 检查环境变量设置
   - 确认网络连接
   - 查看错误日志

### 调试模式

在小程序开发工具中可以看到详细的调试日志：
- `[DEBUG]` 标记的日志用于调试
- 云函数执行状态和错误信息
- 会员状态检查结果

## 更新日志

### v1.0.0 (2023-12-01)
- ✅ 基础会员码生成功能
- ✅ 批量上传到云数据库
- ✅ 用户激活会员码
- ✅ 章节权限控制
- ✅ 前端界面和交互
- ✅ 完整测试和文档