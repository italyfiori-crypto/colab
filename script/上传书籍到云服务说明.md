# 书籍数据上传到微信云服务使用说明

## 概述

这个脚本用于将 `output/` 目录下的有声书数据批量上传到微信云开发环境中，包括：
- 书籍封面图片 → 云存储
- 音频文件 → 云存储  
- 书籍信息 → books 数据库集合
- 章节内容 → chapters 数据库集合

## 前置准备

### 1. 获取必要信息

需要准备以下信息：

1. **AppID**: `wx7040936883aa6dad` (已配置)
2. **AppSecret**: 从微信小程序后台获取
   - 登录 [微信公众平台](https://mp.weixin.qq.com)
   - 进入小程序后台 → 开发 → 开发设置
   - 复制 AppSecret（需要管理员扫码验证）
3. **云环境ID**: 从微信云控制台获取
   - 登录 [微信云控制台](https://console.cloud.weixin.qq.com)
   - 选择对应的云环境，在概览页面查看环境ID

### 2. 创建数据库集合

在微信云控制台中创建以下集合：

1. **books** 集合 - 存储书籍信息
2. **chapters** 集合 - 存储章节内容

### 3. 安装依赖

```bash
pip install requests
```

## 使用步骤

### 1. 运行上传脚本

```bash
cd /Users/yulu/Documents/code/mini_lang
python upload_books_to_cloud.py
```

### 2. 按提示输入配置信息

- AppID: 直接回车使用默认值
- AppSecret: 输入从小程序后台获取的密钥
- 云环境ID: 输入云环境标识符

### 3. 确认上传

脚本会显示配置信息并询问确认，输入 `y` 开始上传。

### 4. 等待上传完成

脚本会自动处理：
- 解析 output 目录下所有书籍的 meta.json
- 上传封面图片和音频文件到云存储
- 将书籍和章节数据插入数据库

## 数据结构说明

### books 表结构
```javascript
{
  _id: "alice",              // 书籍ID (目录名)
  title: "爱丽丝梦游仙境",    // 书名
  author: "Lewis Carroll",   // 作者
  cover: "cloud://...",      // 封面图片云存储ID
  category: "literature",    // 分类
  description: "书籍描述",    // 描述
  totalChapters: 12,         // 总章节数
  estimatedTime: 145,        // 预估学习时长(分钟)
  // ...其他字段
}
```

### chapters 表结构
```javascript
{
  _id: "alice_1_1",          // 章节ID (书籍ID_章节_子章节)
  bookId: "alice",           // 所属书籍ID
  chapterNumber: 1,          // 章节号
  subChapterNumber: 1,       // 子章节号
  title: "Down the Rabbit-Hole(1)", // 章节标题
  content: "章节文本内容",    // 章节内容
  audioUrl: "cloud://...",   // 音频文件云存储ID
  // ...其他字段
}
```

## 日志和排错

- 运行日志保存在 `upload_books.log` 文件中
- 脚本会显示上传进度和错误信息
- 如果上传失败，检查网络连接和API配置

## 注意事项

1. **数据安全**: AppSecret 是敏感信息，请妥善保管
2. **网络要求**: 需要稳定的网络连接，大文件上传可能耗时较长
3. **存储配额**: 注意云存储的容量限制
4. **API限制**: 微信云服务有调用频率限制，脚本已内置重试机制

## 验证上传结果

上传完成后，可以在微信云控制台中验证：

1. **数据库**: 检查 books 和 chapters 集合是否有数据
2. **云存储**: 检查 books/ 目录下是否有上传的文件
3. **小程序**: 在小程序中测试数据获取和文件访问

## 故障排除

### 常见错误及解决方案

1. **Access Token 获取失败**
   - 检查 AppID 和 AppSecret 是否正确
   - 确认小程序状态正常

2. **文件上传失败** 
   - 检查文件是否存在
   - 确认云存储服务已开通
   - 检查网络连接

3. **数据库插入失败**
   - 确认数据库集合已创建
   - 检查数据格式是否正确
   - 确认云环境ID正确

如有问题，请查看详细日志文件 `upload_books.log`。