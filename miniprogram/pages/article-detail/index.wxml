<view class="container">
  <!-- 字幕滚动区域 -->
  <scroll-view 
    class="subtitle-container" 
    scroll-y 
    scroll-into-view="{{currentSubtitleId}}"
    scroll-into-view-offset="{{scrollOffset}}"
    scroll-with-animation="{{true}}"
  >
    <view class="subtitle-list">
      <!-- 字幕内容 -->
      <view 
        wx:for="{{subtitles}}" 
        wx:key="index"
        id="subtitle-{{index}}"
        class="subtitle-item {{currentIndex === index ? 'active' : ''}}"
      >
        <!-- 左侧时间标记和AI解析按钮 -->
        <view class="left-column">
          <view class="time-marker" bindtap="onTimeClick" data-time="{{item.time}}" data-index="{{index}}">
            {{item.timeText}}
          </view>
          <view class="ai-analysis-btn" bindtap="onAnalysisClick" data-index="{{index}}">
            解析
          </view>
        </view>
        
        <!-- 字幕内容区域（右侧） -->
        <view class="subtitle-content">
          <view class="subtitle-english" wx:if="{{subtitleMode === 'en' || subtitleMode === 'both'}}">
            <text 
              wx:for="{{item.englishWords}}" 
              wx:key="index"
              class="{{item.isWord ? 'word-clickable' : 'punctuation'}}"
              bindtap="{{item.isWord ? 'onWordClick' : ''}}"
              data-word="{{item.text}}"
            >{{item.text}}</text>
          </view>
          <view class="subtitle-chinese" wx:if="{{subtitleMode === 'zh' || subtitleMode === 'both'}}">{{item.chinese}}</view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- 底部控制栏 -->
  <view class="control-bar">
    <!-- 第一行：功能按钮 -->
    <view class="top-controls">
      <!-- 单词 -->
      <view class="top-control-btn" bindtap="onDict">
        <image class="top-control-icon" src="/resource/icons/book.svg" mode="aspectFit"></image>
      </view>
      
      <!-- 重复播放 -->
      <view class="top-control-btn {{isLooping ? 'active' : ''}}" bindtap="onRepeat">
        <image class="top-control-icon" src="/resource/icons/repeat.svg" mode="aspectFit"></image>
      </view>
      
      <!-- 字幕设置 -->
      <view class="top-control-btn" bindtap="onSubtitleSettings">
        <image class="top-control-icon" src="/resource/icons/language.svg" mode="aspectFit"></image>
      </view>
      
      <!-- 倍速设置 -->
      <view class="top-control-btn" bindtap="onSpeedChange">
        <image class="top-control-icon" src="/resource/icons/gauge.svg" mode="aspectFit"></image>
      </view>
    </view>
    
    <!-- 第二行：进度条 -->
    <view class="progress-container">
      <slider 
        class="progress-slider"
        min="0"
        max="{{duration}}"
        value="{{currentTime}}"
        activeColor="rgb(52, 152, 219)"
        backgroundColor="#e0e0e0"
        block-size="12"
        bindchange="onProgressChange"
        bindchanging="onProgressChanging"
      />
    </view>
    
    <!-- 第三行：播放控制 -->
    <view class="controls">
      <!-- 上一句 -->
      <view class="control-btn" bindtap="onPrevious">
        <image class="control-icon" src="/resource/icons/backward.svg" mode="aspectFit"></image>
      </view>
      
      <!-- 播放/暂停 -->
      <view class="control-btn play-btn" bindtap="onPlayPause">
        <image 
          class="control-icon" 
          src="{{isPlaying ? '/resource/icons/pause.svg' : '/resource/icons/play.svg'}}" 
          mode="aspectFit"
        ></image>
      </view>
      
      <!-- 下一句 -->
      <view class="control-btn" bindtap="onNext">
        <image class="control-icon" src="/resource/icons/forward.svg" mode="aspectFit"></image>
      </view>
    </view>
  </view>


  <!-- 单词卡片弹出层 -->
  <view class="vocabulary-overlay {{showVocabulary ? 'show' : ''}}" bindtap="onCloseVocabulary">
    <view 
      class="vocabulary-card {{showVocabulary ? 'slide-up' : ''}}" 
      catchtap="stopPropagation"
      bindtouchstart="onCardTouchStart"
      bindtouchmove="onCardTouchMove"
      bindtouchend="onCardTouchEnd"
    >
      <!-- 简单的拖拽把手 -->
      <view class="drag-handle"></view>
      
      <!-- 弹窗标题 -->
      <view class="vocabulary-header">
        <text class="vocabulary-title">章节单词</text>
        <text class="vocabulary-count">共{{vocabularyWords.length}}个</text>
      </view>
      
      <!-- 单词列表 -->
      <scroll-view 
        class="vocabulary-content" 
        scroll-y="{{true}}" 
        bindscrolltolower="onScrollToLower">
        <view class="word-list">
          <view 
            wx:for="{{vocabularyWords}}" 
            wx:key="id"
            class="word-item"
            data-word="{{item}}"
            bindtap="onWordTap"
          >
            <!-- 序号容器 -->
            <view class="word-number-container">
              <view class="word-number">{{index + 1}}</view>
            </view>
            
            <!-- 内容区域 -->  
            <view class="word-content">
              <!-- 单词信息 -->
              <view class="word-main">
                <view class="word-text">{{item.word}}</view>
                <view wx:if="{{item.displayPhonetic}}" class="word-phonetic">
                  /{{item.displayPhonetic}}/
                </view>
              </view>
              
              <!-- 翻译区域 -->
              <view class="word-translation">
                <view class="translation-content">
                  <view wx:for="{{item.translation}}" wx:key="index" wx:for-item="trans" class="translation-item">
                    <text wx:if="{{trans.type}}" class="part-of-speech">{{trans.type}}</text>
                    <text class="meaning">{{trans.meaning}}</text>
                  </view>
                </view>
              </view>
              
              <!-- 右侧：收藏按钮 -->
              <view class="word-actions" catchtap="onToggleFavorite" data-id="{{item._id}}">
                <view class="favorite-btn {{item.is_favorited ? 'favorited' : ''}}">
                  <image class="favorite-icon" src="{{item.is_favorited ? '/resource/icons/star-fill.png' : '/resource/icons/star.png'}}" mode="aspectFit"></image>
                </view>
              </view>
            </view>
          </view>
          
          <!-- 加载状态提示 -->
          <view wx:if="{{loadingMore}}" class="loading-more">加载中...</view>
          <view wx:elif="{{!hasMoreWords && vocabularyWords.length > 0}}" class="no-more">没有更多了</view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 单词详情弹窗 -->
  <view class="word-detail-overlay {{showWordDetail ? 'show' : ''}}" bindtap="onCloseWordDetail">
    <view 
      class="word-detail-modal {{showWordDetail ? 'slide-up' : ''}}" 
      catchtap="stopPropagation"
    >
      <!-- 弹窗头部 -->
      <!-- 单词信息内容 -->
      <view class="word-detail-content">
        <!-- 单词主要信息 -->
        <view class="word-main-info">
          <view class="word-title">{{currentWord.word}}</view>
          <view class="word-phonetic-info" wx:if="{{currentWord.phonetic_uk || currentWord.phonetic_us}}">
            <!-- 英式音标 -->
            <view wx:if="{{currentWord.phonetic_uk}}" class="phonetic-item" bindtap="onPlayAudio" data-type="uk">
              <image class="speaker-icon" src="/resource/icons/volume.svg" mode="aspectFit"></image>
              <text class="phonetic-label">英</text>
              <text class="phonetic-text">/{{currentWord.phonetic_uk}}/</text>
            </view>
            
            <!-- 美式音标 -->
            <view wx:if="{{currentWord.phonetic_us}}" class="phonetic-item" bindtap="onPlayAudio" data-type="us">
              <image class="speaker-icon" src="/resource/icons/volume.svg" mode="aspectFit"></image>
              <text class="phonetic-label">美</text>
              <text class="phonetic-text">/{{currentWord.phonetic_us}}/</text>
            </view>
          </view>
        </view>
        
        <!-- 释义列表 -->
        <view class="translations-section">
          <view class="section-title">释义</view>
          <view class="translations-list">
            <view wx:for="{{currentWord.translation}}" wx:key="index" class="translation-item-detail">
              <view wx:if="{{item.type}}" class="pos-tag">{{item.type}}</view>
              <view class="translation-content">
                <view class="meaning-text">{{item.meaning}}</view>
              </view>
            </view>
          </view>
        </view>
        
        <!-- 标签信息 -->
        <view class="tags-section" wx:if="{{currentWord.translatedTags && currentWord.translatedTags.length}}">
          <view class="section-title">标签</view>
          <view class="tags-list">
            <text wx:for="{{currentWord.translatedTags}}" wx:key="*this" class="tag-item">{{item}}</text>
          </view>
        </view>
      </view>
      
      <!-- 底部操作按钮 -->
      <view class="word-detail-actions">
        <view class="action-btn secondary" bindtap="onCloseWordDetail">
          关闭
        </view>
        <view class="action-btn primary {{currentWord.is_favorited ? 'collected' : ''}}" bindtap="onToggleWordCollection">
          {{currentWord.is_favorited ? '已收藏' : '加入单词本'}}
        </view>
      </view>
    </view>
  </view>

  <!-- AI解析弹窗 -->
  <view class="ai-analysis-overlay {{showAiAnalysis ? 'show' : ''}}" bindtap="onCloseAiAnalysis">
    <view 
      class="ai-analysis-modal {{showAiAnalysis ? 'slide-up' : ''}}" 
      catchtap="stopPropagation"
      bindtouchstart="onAnalysisCardTouchStart"
      bindtouchmove="onAnalysisCardTouchMove"
      bindtouchend="onAnalysisCardTouchEnd"
    >
      <!-- 拖拽把手 -->
      <view class="drag-handle"></view>
      
      <!-- 弹窗头部 -->
      <view class="ai-analysis-header">
        <view class="header-left">
          <text class="ai-analysis-title">智能解析</text>
        </view>
        <view class="close-btn" bindtap="onCloseAiAnalysis">
          <text class="close-icon">✕</text>
        </view>
      </view>
      
      <!-- 解析内容 -->
      <scroll-view class="ai-analysis-content" scroll-y="{{true}}">
        <!-- 加载状态 -->
        <view wx:if="{{analysisLoading}}" class="status-container loading-container">
          <view class="status-icon">
            <view class="loading-spinner"></view>
          </view>
          <text class="status-text">AI正在分析语句...</text>
        </view>
        
        <!-- 错误状态 -->
        <view wx:elif="{{analysisError}}" class="status-container error-container">
          <view class="status-icon">❌</view>
          <text class="status-text">{{analysisError}}</text>
          <view class="retry-btn" bindtap="onRetryAnalysis">
            <text>重新获取</text>
          </view>
        </view>
        
        <!-- 解析结果 -->
        <view wx:else class="analysis-content-wrapper">
          <!-- 原文翻译 -->
          <view class="analysis-card">
            <view class="card-header">
              <text class="card-title">原文翻译</text>
            </view>
            <view class="card-content">
              <view class="text-pair">
                <view class="original-text">{{analysisData.english_text}}</view>
                <view class="translation-text">{{analysisData.chinese_text}}</view>
              </view>
            </view>
          </view>
          
          <!-- 句子结构 -->
          <view class="analysis-card" wx:if="{{analysisData.sentence_structure}}">
            <view class="card-header">
              <text class="card-title">句子结构</text>
            </view>
            <view class="card-content">
              <view class="structure-text">{{analysisData.sentence_structure}}</view>
              <view class="structure-explanation" wx:if="{{analysisData.structure_explanation}}">
                {{analysisData.structure_explanation}}
              </view>
            </view>
          </view>
          
          <!-- 重点单词 -->
          <view class="analysis-card" wx:if="{{analysisData.key_words && analysisData.key_words.length > 0}}">
            <view class="card-header">
              <text class="card-title">重点单词</text>
              <view class="count-badge">{{analysisData.key_words.length}}</view>
            </view>
            <view class="card-content">
              <view class="key-words-grid">
                <view wx:for="{{analysisData.key_words}}" wx:key="word" class="key-word-card">
                  <view class="word-info-inline">
                    <text class="word-text">{{item.word}}</text>
                    <text class="word-pos">{{item.pos}}</text>
                    <text class="word-meaning">{{item.meaning}}</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
          
          <!-- 固定短语 -->
          <view class="analysis-card" wx:if="{{analysisData.fixed_phrases && analysisData.fixed_phrases.length > 0}}">
            <view class="card-header">
              <text class="card-title">固定短语</text>
              <view class="count-badge">{{analysisData.fixed_phrases.length}}</view>
            </view>
            <view class="card-content">
              <view class="phrases-list">
                <view wx:for="{{analysisData.fixed_phrases}}" wx:key="phrase" class="phrase-card">
                  <view class="phrase-info-inline">
                    <text class="phrase-text">{{item.phrase}}</text>
                    <text class="phrase-meaning">{{item.meaning}}</text>
                  </view>
                </view>
              </view>
            </view>
          </view>
          
          <!-- 口语表达 -->
          <view class="analysis-card" wx:if="{{analysisData.colloquial_expression && analysisData.colloquial_expression.length > 0}}">
            <view class="card-header">
              <text class="card-title">口语表达</text>
              <view class="count-badge">{{analysisData.colloquial_expression.length}}</view>
            </view>
            <view class="card-content">
              <view class="colloquial-list">
                <view wx:for="{{analysisData.colloquial_expression}}" wx:key="formal" class="colloquial-card">
                  <view class="expression-comparison">
                    <text class="expression-text formal">{{item.formal}}</text>
                    <view class="arrow">→</view>
                    <text class="expression-text informal">{{item.informal}}</text>
                  </view>
                  <view class="expression-explanation" wx:if="{{item.explanation}}">
                    {{item.explanation}}
                  </view>
                </view>
              </view>
            </view>
          </view>
        </view>
      </scroll-view>
    </view>
  </view>
</view> 